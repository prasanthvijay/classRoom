<?php

namespace Trax\AdminBundle\Controller;
use Trax\AdminBundle\ExtraFunction\myownclass;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\HttpFoundation\Session\Session;
use Symfony\Component\HttpFoundation\RedirectResponse;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Trax\AdminBundle\Entity\TblUser;
use Trax\AdminBundle\Entity\TblLocation;
use Trax\AdminBundle\Entity\TblDepartment;
use Trax\AdminBundle\Entity\TblTrainingprogram;
use Trax\AdminBundle\Entity\TblTrainingschedule;
use Trax\AdminBundle\Entity\TblEmployee;
use Trax\AdminBundle\Entity\TblBatch;
use Trax\AdminBundle\Entity\TblModulecategory;
use Trax\AdminBundle\Entity\TblModulefiles;
use Trax\AdminBundle\Entity\TblMapmodule;
use Trax\AdminBundle\Entity\TblBasicdetails;
use Trax\AdminBundle\Entity\TblModulesubcategory;
use Trax\AdminBundle\Entity\TblViewHistory;
use Trax\AdminBundle\Entity\TblMapbatchtoemployee;

class AdminController extends Controller
{
    public function indexAction(Request $request)
    {
        return $this->render('TraxAdminBundle:Admin:index.html.php');
    }
	public function getFunctionAction(Request $request)
    {
		$em = $this->getDoctrine()->getEntityManager();
        	$session = $request->getSession();
		$getFunctionType=$request->get('type'); 
		$loginuserId = $session->get('loginuserId');
		$frmoapp=$request->get('frmoapp'); 
		$myownclass = new myownclass();
		if($getFunctionType=="LoginCheck"){
			$username=$request->get('username');
			$password=$request->get('password');

			$userList = $em->createQuery("SELECT j.userid,j.usertypeid,j.customername FROM TraxAdminBundle:TblUser j  where j.username='".$username."' and j.password='".$password."'")->getArrayResult();

			if($userList[0]['usertypeid']=='1')
			{		
				$session->set('loginId', $userList[0]['userid']);
				$session->set('loginuserId', $userList[0]['userid']);
				$session->set('loginExeType', $userList[0]['usertypeid']);
				$_SESSION['ExeType']= $userList[0]['usertypeid'];
				$_SESSION['customername']= $userList[0]['customername'];
				echo trim($userList[0]['usertypeid']);
				
			}
			else if($userList[0]['usertypeid']=='2'){
				$session->set('loginId', $userList[0]['userid']);
				$session->set('loginuserId', $userList[0]['userid']);
				$session->set('loginExeType', $userList[0]['usertypeid']);
				$_SESSION['ExeType']= $userList[0]['usertypeid'];
				$_SESSION['customername']= $userList[0]['customername'];
				echo trim($userList[0]['usertypeid']);
			}
			

		}
		if($getFunctionType=="LoginCheckApp"){
			$username=$request->get('username');
			$password=$request->get('password');

			$userList = $em->createQuery("SELECT j.empid,j.employeename,j.employeetype,k.username,k.usertypeid,k.mobileno,k.userid FROM TraxAdminBundle:TblEmployee j INNER JOIN TraxAdminBundle:TblUser k with k.userid=j.userid  where k.username='".$username."' and k.password='".$password."'")->getArrayResult();


				if($userList[0]['usertypeid']=='4')
				{		
					
					$userListarray[0]['userid']=(string)$userList[0]['userid'];
					//$userListarray[0]['usertypeid']=(string)$userList[0]['usertypeid'];
					$userListarray[0]['customername']=$userList[0]['employeename'];
					$userListarray[0]['empid']=(string)$userList[0]['userid'];
				}
				
				
		}
		if($getFunctionType=="getcontentdoclist"){

		$empid=$request->get('empid');		
		
		$mapemploeelist = $em->createQuery("SELECT j.mapmoduleid FROM TraxAdminBundle:TblMapbatchtoemployee j where j.employeeid='".$empid."'")->getArrayResult();
				
		for($i=0;$i<count($mapemploeelist);$i++)
			{

			$mapmodulelist =$myownclass->queryExecute("select * from tbl_mapModule  where mapId='".$mapemploeelist[$i]['mapmoduleid']."'");
				for($j=0;$j<count($mapmodulelist);$j++){

					$mapcategory = $em->createQuery("SELECT j.cateid,j.modulecategory FROM TraxAdminBundle:TblModulecategory j where j.cateid='".$mapmodulelist[$j]['categoryId']."'")->getArrayResult();

					$mapsubcategory = $em->createQuery("SELECT j.subcatid,j.subcategory FROM TraxAdminBundle:TblModulesubcategory j where j.subcatid in (".$mapmodulelist[$j]['subCategory'].")")->getArrayResult();		

					$mapmodulelistarray[$i]['category']=$mapcategory[$j]['modulecategory'];
					$mapmodulelistarray[$i]['scheduleDate']=$mapmodulelist[$j]['scheduleDate'];
					$mapmodulelistarray[$i]['modulesubcategory']=$mapsubcategory;
					$mapmodulelistarray[$i]['mapId']=$mapmodulelist[$j]['mapId'];
				}

			
			}

			


		}
		if($getFunctionType=="getTrainingProgram"){	
			$batchId=$request->get('batchId'); 	
			$trainingprogramList = $em->createQuery("SELECT j.prgid,j.programname FROM TraxAdminBundle:TblTrainingprogram j where j.adminid='".$loginuserId."' and j.batchid='".$batchId."'")->getArrayResult();
		}
		if($getFunctionType=="ModuleFile"){	
			$empid=$request->get('empid'); 	
			$subcatid=$request->get('subcatid'); 
			$mapId=$request->get('mapId'); 
			$mapModuleFileArray=array();

			$mapModule =$myownclass->queryExecute("select * from tbl_mapModule  where mapId='".$mapId."'");
			$mapModuleFile = $em->createQuery("SELECT j FROM TraxAdminBundle:TblModulefiles j where j.subcategory ='".$subcatid."'")->getArrayResult();
			$Module=explode(',',$mapModule[0]['moduleId']);
			$Module2="";
			for($j=0;$j<count($mapModuleFile);$j++){		
						$Module2.=$mapModuleFile[$j]['moduleid'].",";
			}
			$moduleAr=rtrim($Module2,',');
			$ModuleArray=explode(',',$moduleAr);	
			$moduleid= implode(',',array_intersect($ModuleArray,$Module));
		
			//echo "<br>";print_r($Module);		
			//echo "<br>";print_r($ModuleArray);
			$mapModuleFileArr = $em->createQuery("SELECT j FROM TraxAdminBundle:TblModulefiles j where j.moduleid in (".$moduleid.")")->getArrayResult();
			$mapModuleFileArray=$mapModuleFileArr;	
			
		}
		if($getFunctionType=="getEmployeeList"){	
			$departId=$request->get('departId'); 
			$EmployeeList = $em->createQuery("SELECT j.empid,j.employeename FROM TraxAdminBundle:TblEmployee j where j.customerid='".$loginuserId."' and j.department='".$departId."' and j.employeetype='Employee'")->getArrayResult();	
			
		}
		if($getFunctionType=="ExistEmployee"){	
			$trainerNamelist = $em->createQuery("SELECT j.empid,j.employeename FROM TraxAdminBundle:TblEmployee j where j.customerid='".$loginuserId."' and j.employeetype='Trainer'")->getArrayResult();	
			
		}
		if($getFunctionType=="getsubCategory"){	
			$catid=$request->get('catid'); 	
			$subCategoryList = $em->createQuery("SELECT j.subcatid,j.subcategory FROM TraxAdminBundle:TblModulesubcategory j where j.catid='".$catid."' ")->getArrayResult();	
			
		}
		if($getFunctionType=="checkUserName"){
			$username=$request->get('username');
			$userlist = $em->createQuery("SELECT j.username FROM TraxAdminBundle:TblUser j  where j.username='".$username."'")->getArrayResult();
		}
		if($getFunctionType=="SessionList"){

			 $empid=$request->get('empid');
			$sessionList = $em->createQuery("SELECT j.scheduledate FROM TraxAdminBundle:TblTrainingschedule j  where j.employeeid='".$empid."'")->getArrayResult();
			for($i=0;$i<count($sessionList);$i++){
			$sessionListarray[$i]=date_format($sessionList[$i]['scheduledate'],'Y-m-d');
			}

		}
		if($getFunctionType=="SessionListEmp"){

			 $empid=$request->get('empid');
			$date=explode('T',$request->get('date'));
			$newdate=$date[0]." 00:00:00";
			
			$sessionList = $em->createQuery("SELECT k.batchname,l.programname,j.trainername FROM TraxAdminBundle:TblTrainingschedule j INNER JOIN TraxAdminBundle:TblBatch k with k.batchid=j.batchid INNER JOIN TraxAdminBundle:TblTrainingprogram l with l.prgid=j.programid where j.employeeid='".$empid."' and j.scheduledate='".$newdate."'")->getArrayResult();
			for($i=0;$i<count($sessionList);$i++){

			$sessionListEmparray[$i]['batchname']=$sessionList[$i]['batchname'];
			$sessionListEmparray[$i]['programname']=$sessionList[$i]['programname'];
			$sessionListEmparray[$i]['trainername']=$sessionList[$i]['trainername'];
			}

		}

		if($getFunctionType=="getfileinfo"){

			$empid=$request->get('empid');
			$moduleid=$request->get('id');

$mapmodulefileslist = $em->createQuery("SELECT j.moduleid,j.modulename,j.filename FROM TraxAdminBundle:TblModulefiles j where j.moduleid='".$moduleid."'")->getArrayResult();

		}
		if($getFunctionType=="getCategoryList"){
			
			$trainerId=$request->get('trainerId');
			$Categorylist=$em->createQuery("SELECT j.cateid,j.modulecategory,j.description  FROM TraxAdminBundle:TblModulecategory j  where j.trainerid='".$trainerId."'")->getArrayResult();
		}
		if($getFunctionType=="getCategoryListmap"){
			
			$trainerId=$request->get('trainerId');
			$Categorylist=$em->createQuery("SELECT j.cateid,j.modulecategory,j.description  FROM TraxAdminBundle:TblModulecategory j  where j.trainerid='".$trainerId."'")->getArrayResult();
		}
		if($getFunctionType=="employeeDetails"){

			$customerId=$request->get('customerId');
			$employeename=$request->get('employeename');
			$employeeArray="";
			$employeeList = $em->createQuery("SELECT j.employeename,j.chorusid FROM TraxAdminBundle:TblBasicdetails j  where j.employeename like '%".$employeename."%'")->getArrayResult();
			for($i=0;$i<count($employeeList);$i++){
				$employeeArray[$i]=$employeeList[$i]['employeename']."(".$employeeList[$i]['chorusid'].")";
			}

		}
		if($getFunctionType=="getEmplist"){

			$deprtId=$request->get('deprtId');
			$departList=$em->createQuery("SELECT j.department,j.dprtid  FROM TraxAdminBundle:TblDepartment j where j.dprtid in (".$deprtId.")")->getArrayResult();
				
		}

if($getFunctionType=="getEmplisttrainer"){

			$deprtId=$request->get('deprtId');
				$departList=$em->createQuery("SELECT j.department,j.dprtid  FROM TraxAdminBundle:TblDepartment j where j.dprtid in (".$deprtId.")")->getArrayResult();

$employeeList = $em->createQuery("SELECT j.empid,j.userid FROM TraxAdminBundle:TblEmployee j  where j.empid = '".$loginuserId."' ")->getArrayResult();


$userlistid = $em->createQuery("select j.adminid FROM TraxAdminBundle:TblUser j where j.userid='".$employeeList[0]['userid']."'")->getArrayResult();




				
		}

		if($getFunctionType=="EmployeefullDetails"){

			$customerId=$request->get('customerId');
			$employeeId=explode('(',$request->get('employeeId'));
			$employeeIdnew=explode(')',$employeeId[1]);
			$employeeArray="";

			$employeeList = $em->createQuery("SELECT j.chorusid,j.emaiid,j.guid FROM TraxAdminBundle:TblBasicdetails j  where j.customerid='".$customerId."' and j.chorusid='".$employeeIdnew[0]."'")->getArrayResult();

			for($i=0;$i<count($employeeList);$i++){
				$employeeArray[0]=$employeeList[$i]['chorusid'];
				$employeeArray[1]=$employeeList[$i]['emaiid'];
				$employeeArray[2]=$employeeList[$i]['guid'];
			}

		}
		if($getFunctionType=="getDepartment"){	


			$departList = $em->createQuery("SELECT j.dprtid,j.department  FROM TraxAdminBundle:TblDepartment j  where j.customerid ='".$loginuserId."'")->getArrayResult();

			$deptListarray['departmList']=$departList;
			
		}
		if($getFunctionType=="getsubCategoryMultiple"){	

			$catid=$request->get('catid');
			$subCategoryList = $em->createQuery("SELECT j.subcatid,j.subcategory FROM TraxAdminBundle:TblModulesubcategory j where j.catid='".$catid."' ")->getArrayResult();
			$deptListarray['subCategoryList']=$subCategoryList;
			
		}

		if($getFunctionType=="getModuleFile"){	
			$subCategoryListarray=array();
			$subCategory=$request->get('subCategory');
			$subCategoryList = $em->createQuery("SELECT j.subcatid,j.subcategory FROM TraxAdminBundle:TblModulesubcategory j where j.subcatid in (".$subCategory.") ")->getArrayResult();

			$subCategoryListarray=$subCategoryList;
		}
if($getFunctionType=="getDepartmenttrainer"){	


			$departList = $em->createQuery("SELECT j.dprtid,j.department  FROM TraxAdminBundle:TblDepartment j  where j.customerid ='2'")->getArrayResult();

			$deptListarray['departmList']=$departList;
			
		}
		if($getFunctionType=="Changepassword"){

			
				 $userid=$request->get('userid');
				 $password=$request->get('password');
				 $newpassword=$request->get('newpassword');
		

		$userlist = $em->createQuery("SELECT j.userid,j.username,j.emailid,j.password FROM TraxAdminBundle:TblUser j  where j.userid='".$userid."' and j.password='".$password."'" )->getArrayResult();

		if(count($userlist) > 0)
		{
		$em->createQuery("update TraxAdminBundle:TblUser j set j.password='".$newpassword."' WHERE j.userid='".$userlist[0]['userid']."' ")->execute();
		}
		$successmsg[0]['msg']='success';
			}
		if($getFunctionType=="SendEmail"){

				 $email=$request->get('email');

		$usermaillist = $em->createQuery("SELECT j.customername,j.emailid FROM TraxAdminBundle:TblUser j  where j.emailid='".$email."'")->getArrayResult();
		$newpassword = mt_rand(100000, 999999);
	

		}
		if($getFunctionType=="makeOption"){

				 $empId=$request->get('empId');
				 $currentType=$request->get('currentType');

				
				 $em->createQuery("update TraxAdminBundle:TblEmployee p set p.employeetype='".$currentType."' WHERE p.empid='".$empId."' ")->execute();

		}
if($getFunctionType=="updatedatepicker"){


				$id=$request->get('id');
				 $subcatid=$request->get('subcatid'.$id);
				 $date=$request->get('reservation'.$id);


				 $em->createQuery("update TraxAdminBundle:TblMapmodule p set p.scheduledate='".$date."' WHERE p.subcategory='".$subcatid."' ")->execute();

		}
if($getFunctionType=="viewhistory"){


				$empid=$request->get('empid');
				 $moduleid=$request->get('moduleid');

$usermaillist = $em->createQuery("SELECT j FROM TraxAdminBundle:TblViewHistory j  where j.moduleId='".$moduleid."' and j.empid='".$empid."'")->getArrayResult();
if(count($usermaillist) <= 0)
{

					$insert=new TblViewHistory();
					$insert->setEmpid($empid);
					$insert->setModuleId($moduleid);
					$insert->setViewDate(new \DateTime());	
					$em->persist($insert);
					$em->flush();
}

$successmsg[0]['msg']='success';
				

		}
        return $this->render('TraxAdminBundle:Admin:getFunction.html.php',array('getFunctionType'=>$getFunctionType,'trainingprogramList'=>$trainingprogramList,'EmployeeList'=>$EmployeeList,'trainerNamelist'=>$trainerNamelist,'userlist'=>$userlist,'frmoapp'=>$frmoapp,'userListarray'=>$userListarray,'mapmodulelistarray'=>$mapmodulelistarray,'sessionListarray'=>$sessionListarray,'mapmodulelistfilearray'=>$mapmodulelistfilearray,'mapmodulefileslist'=>$mapmodulefileslist,'sessionListEmparray'=>$sessionListEmparray,'employeeArray'=>$employeeArray,'subCategoryList'=>$subCategoryList,'Categorylist'=>$Categorylist,'departList'=>$departList,'employeeList'=>$employeeList,'em'=>$em,'loginuserId'=>$loginuserId,'deptListarray'=>$deptListarray,'userlistid'=>$userlistid,'successmsg'=>$successmsg,'usermaillist'=>$usermaillist,'newpassword'=>$newpassword,'subCategoryListarray'=>$subCategoryListarray,'mapModuleFileArray'=>$mapModuleFileArray));
    }
 public function adminMasterAction(Request $request)
   {

		$em = $this->getDoctrine()->getEntityManager();
        	$session = $request->getSession();
		$loginExeType = $session->get('loginExeType');
		$master=$request->get('master');
		$loginuserId = $session->get('loginuserId');
		$deleteId=$request->get('deleteId'); 	
		if($loginExeType==1){			
 		$customerList = $em->createQuery("SELECT j.userid,j.customername FROM TraxAdminBundle:TblUser j  where j.usertypeid=2 and j.status='active' ")->getArrayResult();
		}
		if($deleteId!=""){
			if($master=='Customer')
				{

				$em->createQuery("Delete FROM TraxAdminBundle:TblUser j where j.userid='".$deleteId."'")->getArrayResult();
			
				}
			if($master=='Employee')
				{
			
				$em->createQuery("Delete FROM TraxAdminBundle:TblEmployee j where j.userid='".$deleteId."'")->getArrayResult();
				$em->createQuery("Delete FROM TraxAdminBundle:TblUser j where j.userid='".$deleteId."'")->getArrayResult();
				}
			if($master=='Department')
				{

				$em->createQuery("Delete FROM TraxAdminBundle:TblDepartment j where j.dprtid='".$deleteId."'")->getArrayResult();
			
				}
			if($master=='Location')
				{

				$em->createQuery("Delete FROM TraxAdminBundle:TblLocation j where j.zoneid='".$deleteId."'")->getArrayResult();
			
				}
			if($master=='TrainingBatch')
				{

				$em->createQuery("Delete FROM TraxAdminBundle:TblBatch j where j.batchid='".$deleteId."'")->getArrayResult();
			
				}		
			if($master=='TrainingSchedule')
				{

				$em->createQuery("Delete FROM TraxAdminBundle:TblTrainingschedule j where j.scheid='".$deleteId."'")->getArrayResult();
			
				}
			if($master=='TrainingProgram')
				{

				$em->createQuery("Delete FROM TraxAdminBundle:TblTrainingprogram j where j.prgid='".$deleteId."'")->getArrayResult();
			
				}
			if($master=='ModuleCategory')
				{

				$em->createQuery("Delete FROM TraxAdminBundle:TblModulecategory j where j.cateid='".$deleteId."'")->getArrayResult();
			
				}
			if($master=='ModuleSubCategory')
				{

				$em->createQuery("Delete FROM TraxAdminBundle:TblModulesubcategory j where j.subcatid='".$deleteId."'")->getArrayResult();
			
				}
			if($master=='Module')
				{

				$em->createQuery("Delete FROM TraxAdminBundle:TblModulefiles j where j.moduleid='".$deleteId."'")->getArrayResult();
			
				}
			if($master=='loademployeelist')
				{
				 $subcatid=$request->get('subcatid');
				 $empid=$request->get('deleteId');
				$mappedid = $em->createQuery("SELECT j.mapid FROM TraxAdminBundle:TblMapmodule j  where j.subcategory='".$subcatid."' and j.employeeid='".$empid."'")->getArrayResult(); 
				$em->createQuery("Delete FROM TraxAdminBundle:TblMapmodule j where j.mapid='".$mappedid[0]['mapid']."'")->getArrayResult();
			
				}
		}

        return $this->render('TraxAdminBundle:Admin:adminMaster.html.php',array('master'=>$master,'loginExeType'=>$loginExeType,'customerList'=>$customerList,'loginuserId'=>$loginuserId));
    }
public function LoadModalContentAction(Request $request)
    {

		$em = $this->getDoctrine()->getEntityManager();
        	$session = $request->getSession();
		$loginId = $session->get('loginId');
		$loginuserId = $session->get('loginuserId');
		$mastertype=$request->get('type');
		$loginExeType = $session->get('loginExeType');
			if($loginExeType==1){
				$customerList = $em->createQuery("SELECT j.userid,j.customername,j.mobileno,j.address FROM TraxAdminBundle:TblUser j  where j.usertypeid=2 and j.status='active' ")->getArrayResult();
			}
			
			$editId=$request->get('editId');
			if($mastertype=='HomeMenu') 
			{						

				if($editId!=""){
					$editmenuList = $em->createQuery("SELECT j.menuid,j.menu,j.menudescription FROM TraxAdminBundle:TblHomemenu j  where j.status='active' and j.menuid='".$editId."'")->getArrayResult();
					//print_r($editmenuList);
				}
				
			}
			if($mastertype=='Customer') 
			{

				if($editId!=""){
					$editcustomerList = $em->createQuery("SELECT j.userid,j.customername,j.mobileno,j.address,j.username,j.password,j.telephoneno FROM TraxAdminBundle:TblUser j  where j.usertypeid=2 and j.status='active' and j.userid ='".$editId."'")->getArrayResult();

				}
			
			}
			if($mastertype=='Location') 
			{

				if($editId!=""){
					$editLocation = $em->createQuery("SELECT j.zoneid,j.location,j.customerid  FROM TraxAdminBundle:TblLocation j  where j.zoneid ='".$editId."'")->getArrayResult();

				}
			}
			if($mastertype=='Department') 
			{
				$editId=$request->get('editId');
				if($editId!=""){
					$editDepartment = $em->createQuery("SELECT j.dprtid,j.department,j.customerid  FROM TraxAdminBundle:TblDepartment j  where j.dprtid ='".$editId."'")->getArrayResult();

				}
			}
			
			if($mastertype=='TrainingProgram') 
			{
				$batchlist = $em->createQuery("SELECT j.batchid,j.batchname,j.description,j.customerid  FROM TraxAdminBundle:TblBatch j  where j.customerid='".$loginuserId."'")->getArrayResult();

				if($editId!=""){
					$edittrainingProgram = $em->createQuery("SELECT j.prgid,j.programname,j.description,j.batchid  FROM TraxAdminBundle:TblTrainingprogram j  where j.prgid ='".$editId."'")->getArrayResult();

				}
			}
			if($mastertype=='TrainingSchedule') 
			{
				$batchlist = $em->createQuery("SELECT j.batchid,j.batchname,j.description,j.customerid  FROM TraxAdminBundle:TblBatch j  where j.customerid='".$loginuserId."'")->getArrayResult();
				$departList = $em->createQuery("SELECT j.dprtid,j.department  FROM TraxAdminBundle:TblDepartment j  where j.customerid ='".$loginuserId."'")->getArrayResult();
				$moduleCateList=$em->createQuery("SELECT j.cateid,j.modulecategory  FROM TraxAdminBundle:TblModulecategory j  where j.customerid ='".$loginuserId."'")->getArrayResult();

				if($editId!=""){
					$edittrainingProgram = $em->createQuery("SELECT j.prgid,j.programname,j.description,j.batchid  FROM TraxAdminBundle:TblTrainingprogram j  where j.prgid ='".$editId."'")->getArrayResult();
				}
			}
			if($mastertype=='ModuleCategory') 
			{
				$editId=$request->get('editId');
				if($editId!=""){
					$editModuleCategory = $em->createQuery("SELECT j.cateid,j.modulecategory,j.description  FROM TraxAdminBundle:TblModulecategory j  where j.cateid ='".$editId."'")->getArrayResult();

				}
				$TrainerList=$em->createQuery("SELECT j.empid,j.employeename  FROM TraxAdminBundle:TblEmployee j  where j.employeetype ='Trainer' and j.customerid='".$loginuserId."'")->getArrayResult();

			}
			if($mastertype=='ModuleSubCategory') 
			{
				$editId=$request->get('editId');
				
				if($editId!=""){
					$editModuleCategory = $em->createQuery("SELECT k.modulecategory,j.subcategory,j.description,j.subcatid FROM TraxAdminBundle:TblModulesubcategory j INNER JOIN  TraxAdminBundle:TblModulecategory k with k.cateid=j.catid where j.subcatid='".$editId."'")->getArrayResult();

				}
				$TrainerList=$em->createQuery("SELECT j.userid,j.employeename  FROM TraxAdminBundle:TblEmployee j  where j.employeetype ='Trainer' and j.customerid='".$loginuserId."'")->getArrayResult();
			}

			if($mastertype=='Module') 
			{
				$editId=$request->get('editId');
				$ModuleCategory = $em->createQuery("SELECT j.cateid,j.modulecategory FROM TraxAdminBundle:TblModulecategory j where j.customerid ='".$loginuserId."'")->getArrayResult();
			
				if($editId!=""){
					$editmodulefilelist = $em->createQuery("SELECT j.moduleid,j.modulename,j.description,j.modulecategory,j.filename FROM TraxAdminBundle:TblModulefiles j where j.moduleid='".$editId."'")->getArrayResult();

					$editModuleCategory = $em->createQuery("SELECT j.cateid,j.modulecategory,j.description  FROM TraxAdminBundle:TblModulecategory j where j.cateid ='".$editId."'")->getArrayResult();

				}
				$TrainerList=$em->createQuery("SELECT j.userid,j.employeename  FROM TraxAdminBundle:TblEmployee j  where j.employeetype ='Trainer' and j.customerid='".$loginuserId."'")->getArrayResult();

			}
			if($mastertype=='MapModule') 
			{
				$ModuleCategory = $em->createQuery("SELECT j.cateid,j.modulecategory FROM TraxAdminBundle:TblModulecategory j where j.customerid ='".$loginuserId."'")->getArrayResult();
				$departList = $em->createQuery("SELECT j.dprtid,j.department  FROM TraxAdminBundle:TblDepartment j  where j.customerid ='".$loginuserId."'")->getArrayResult();
			}
			
			if($mastertype=='loademployeelist') 
			{
				$subcatid=$request->get('subcatid');

				$getemployeevalue = $em->createQuery("SELECT j.employeeid,j.subcategory FROM TraxAdminBundle:TblMapmodule j  where j.subcategory='".$subcatid."'")->getArrayResult(); 

			}
if($mastertype=='updatescheduledate') 
			{
			 $id=$request->get('id');
			$subcatid=$request->get('subcatid');



			}

        return $this->render('TraxAdminBundle:Admin:LoadModalContent.html.php',array('mastertype'=>$mastertype,'editId'=>$editId,'editDepartment'=>$editDepartment,'editEmployeeList'=>$editEmployeeList,'editLocation'=>$editLocation,'editcustomerList'=>$editcustomerList,'locationList'=>$locationList,'DepartmentList'=>$DepartmentList,'batchlist'=>$batchlist,'edittrainingProgram'=>$edittrainingProgram,'departList'=>$departList,'editModuleCategory'=>$editModuleCategory,'ModuleCategory'=>$ModuleCategory,'editmodulefilelist'=>$editmodulefilelist,'moduleCateList'=>$moduleCateList,'Categorylist'=>$Categorylist,'TrainerList'=>$TrainerList,'getemployeevalue'=>$getemployeevalue,'em'=>$em,'id'=>$id,'subcatid'=>$subcatid));
    }
public function dataTableMasterAction(Request $request)
    {

		$em = $this->getDoctrine()->getEntityManager();
        	$session = $request->getSession();
		$loginId = $session->get('loginId');
		$loginuserId = $session->get('loginuserId');
		$mastertype=$request->get('type');
		$customerId=$request->get('customer');


			if($mastertype=='Customer') {
			
				$customerList = $em->createQuery("SELECT j.username,j.password,j.userid,j.customername,j.mobileno,j.address FROM TraxAdminBundle:TblUser j  where j.usertypeid=2 and j.status='active' ")->getArrayResult();

			}
			
			if($mastertype=='Department'){

					$DepartmentList = $em->createQuery("SELECT j.dprtid,j.department FROM TraxAdminBundle:TblDepartment j  where j.customerid='".$customerId."'")->getArrayResult();
	
			}
			if($mastertype=='Location'){

					$LocationList = $em->createQuery("SELECT j.zoneid,j.location FROM TraxAdminBundle:TblLocation j  where j.customerid='".$customerId."'")->getArrayResult();
	
			}
			if($mastertype=='Employee'){

					$EmployeeList = $em->createQuery("SELECT j.empid,j.employeename,j.employeetype,k.username,k.password,k.mobileno,k.userid FROM TraxAdminBundle:TblEmployee j INNER JOIN TraxAdminBundle:TblUser k with k.userid=j.userid  where j.customerid='".$customerId."'")->getArrayResult();
	
			}
			if($mastertype=='TrainingBatch') 
			{

			$trainingbatchlist = $em->createQuery("SELECT j FROM TraxAdminBundle:TblBatch j where j.customerid='".$customerId."'")->getArrayResult();

			}
			if($mastertype=='TrainingProgram') 
			{
			
			$trainingprogramlist = $em->createQuery("SELECT j.prgid,j.programname,j.description,k.batchname FROM TraxAdminBundle:TblTrainingprogram j  INNER JOIN TraxAdminBundle:TblBatch k with k.batchid=j.batchid  where j.adminid='".$customerId."'")->getArrayResult();

			}
                        if($mastertype=='TrainingSchedule')
			{


			$TrainingSchedulelist = $em->createQuery("SELECT j.scheid,j.scheduledate,k.batchname,l.programname,j.trainername,m.employeename FROM TraxAdminBundle:TblTrainingschedule j  INNER JOIN TraxAdminBundle:TblBatch k with k.batchid=j.batchid  INNER JOIN TraxAdminBundle:TblTrainingprogram l with l.prgid=j.programid INNER JOIN TraxAdminBundle:TblEmployee m with m.empid=j.employeeid where j.customerid='".$customerId."'")->getArrayResult();			
			}
			if($mastertype=='ModuleCategory') 
			{
			
			$CategoryList = $em->createQuery("SELECT j.cateid,j.modulecategory,j.description FROM TraxAdminBundle:TblModulecategory j where j.customerid='".$customerId."'")->getArrayResult();

			}
			if($mastertype=='ModuleSubCategory') 
			{
			
			$SubCategoryList = $em->createQuery("SELECT j FROM TraxAdminBundle:TblModulesubcategory j where j.customerid='".$customerId."'")->getArrayResult();

			}
			if($mastertype=='Module') 
			{
			
			$modulefilelist = $em->createQuery("SELECT j.moduleid,j.modulename,j.description,k.modulecategory,j.filename,j.filepath, j.filetype FROM TraxAdminBundle:TblModulefiles j INNER JOIN TraxAdminBundle:TblModulecategory k with k.cateid=j.modulecategory where j.customerid='".$customerId."'")->getArrayResult();
			}
			if($mastertype=='MapModule') 
			{
		

			//$MapModuleList = $em->createQuery("SELECT j.description,k.modulecategory,j.employeeid,l.subcategory,l.subcatid,j.subcategory as subcatid,j.scheduledate FROM TraxAdminBundle:TblMapmodule j INNER JOIN  TraxAdminBundle:TblModulecategory k with k.cateid=j.categoryid  INNER JOIN TraxAdminBundle:TblModulesubcategory l with l.subcatid=j.subcategory where j.customerid='".$customerId."' group by j.subcategory ")->getArrayResult();

			
			}
if($mastertype=='Viewfilehistory') 
			{
			$historylist = $em->createQuery("SELECT j FROM TraxAdminBundle:TblViewHistory j where j.empid is not null")->getArrayResult();


			}
        return $this->render('TraxAdminBundle:Admin:dataTableMaster.html.php',array('mastertype'=>$mastertype,'customerList'=>$customerList,'LocationList'=>$LocationList,'DepartmentList'=>$DepartmentList,'EmployeeList'=>$EmployeeList,'trainingbatchlist'=>$trainingbatchlist,'trainingprogramlist'=>$trainingprogramlist,'CategoryList'=>$CategoryList,'TrainingSchedulelist'=>$TrainingSchedulelist,'modulefilelist'=>$modulefilelist,'MapModuleList'=>$MapModuleList,'em'=>$em,'SubCategoryList'=>$SubCategoryList,'historylist'=>$historylist));
    }
 public function logoutAction(Request $request)
	{
		$em = $this->getDoctrine()->getEntityManager();
		$session = $request->getSession();
		session_destroy();
		return $this->redirectToRoute('trax_user_homepage');
	
	//return $this->render('TraxAdminBundle:Admin:logout.html.php');
	}

public function InsertAdminMasterAction(Request $request)
    {

		$em = $this->getDoctrine()->getEntityManager();
        	$session = $request->getSession();
		$loginId = $session->get('loginId');
		$loginuserId = $session->get('loginuserId');
		$loginExeType = $session->get('loginExeType');
		$type=$request->get('type');
		if($loginExeType==1){
				$customerId=$request->get('customer'); 
			}else{
				$customerId=$loginId;	
			}
			
			if($type=="Customer")
			{

					$Customername=$request->get('Customername'); 
					$Username=$request->get('Username'); 
					$Password=$request->get('Password');
					$Mobile=$request->get('Mobile');
					$Address=$request->get('Address');
					$id=$request->get('editId');
					$uploadedFilenew = $request->files->get('uploadedFile');
					$uploadfile="";
					$ImagePath="";	
					$date=date("dMY_H:i:s");
					$path_parts = pathinfo($_FILES["uploadedFile"]["name"]);
					$path_parts['dirname'] ;
					$path_parts['basename'] ;
					$exten = $path_parts['extension'] ;
					$filename= $path_parts['filename'] ;
					$uploadedFile = $filename.'_'.$date.'.'.$exten;
									
					if($id=="")
					{
														
						if($uploadedFile!=""){
							$uploadfile = $uploadedFile;
							$uploadurl = '/var/www/html/MichelinClassroom/web/logofile/';
							$directoryName=$uploadurl.$Customername;
							mkdir($directoryName,0777);
							$ImagePath=$directoryName.'/'.$uploadedFile;
							$Tempfile= $_FILES["uploadedFile"]["tmp_name"];
							move_uploaded_file($Tempfile,$ImagePath);
							chmod($ImagePath, 0777);

						}

						$insert=new TblUser();
						$insert->setUsername($Username);
						$insert->setPassword($Password);
						$insert->setCustomername($Customername);
						$insert->setEmailid($Username);
						$insert->setMobileno($Mobile);
						$insert->setAddress($Address);
						$insert->setFilename($uploadfile);
						$insert->setImagepath($ImagePath);
						$insert->setUsertypeid(2); 
						$insert->setAdminid($loginuserId);
						$insert->setCreatedat(new \DateTime());	
						$insert->setStatus("active");
						$em->persist($insert);
						$em->flush();

					}
					else
					{
			
					$em->createQuery("update TraxAdminBundle:TblUser j set j.customername='".$Customername."',j.mobileno='".$Mobile."',j.address='".$Address."',j.telephoneno='".$Telphone."' WHERE j.userid='".$id."' ")->execute();
					
					}
			
			

			}
			
			if($type=="Location")
			{
				$Location=$request->get('Location'); 
				$id=$request->get('editId');

				if($id=="")
				{
					$insert=new TblLocation();
					$insert->setLocation($Location);
					$insert->setCustomerid($customerId);
					$insert->setAdminid($loginId);
					$insert->setCreatedat(new \DateTime());				
					$em->persist($insert);
					$em->flush();

				}
				else
				{
				$em->createQuery("update TraxAdminBundle:TblLocation p set p.location='".$Location."',p.customerid='".$customerId."' WHERE p.zoneid='".$id."' ")->execute();
					
				}	
			}
			if($type=="Department")
			{
				$department=$request->get('department'); 
				$id=$request->get('editId');

				if($id=="")
				{
					$insert=new TblDepartment();
					$insert->setDepartment($department);
					$insert->setCustomerid($customerId);
					$insert->setAdminid($loginId);
					$insert->setCreatedat(new \DateTime());				
					$em->persist($insert);
					$em->flush();

				}
				else
				{
				$em->createQuery("update TraxAdminBundle:TblDepartment p set p.department='".$department."',p.customerid='".$customerId."' WHERE p.dprtid='".$id."' ")->execute();
					
				}	
			}
			if($type=="Employee")
			{

				$val=$request->get('val'); 

				if($val=='1'){
					
					$customerId=$request->get('customerId');
					$loginId=$request->get('loginemployeeuserId');  
					$employeeType="Trainee";
					$usertypeid="4";	
					$loginuserId=$customerId;		
				}
				else{

					if($loginExeType==1){
					$customerId=$request->get('customer'); 
					}else{
					$customerId=$loginId;	
					}
					$userTypeId=$request->get('userTypeId');
					if($userTypeId!=""){
						if($userTypeId=="defaulttrainer"){
						$employeeType="Trainer";
						$usertypeid="3"; 
						}
						else if($userTypeId=="Guesttrainer"){
						$employeeType="Guest Trainer";
						$usertypeid="5"; 
						}
						
					}
					else{
						 $employeeType="Trainee";
						  $usertypeid="4";  
					}
					
	
				}


				$Employeename=explode('(',$request->get('Employeename'));
				$Username=$request->get('Username');
				$gender=$request->get('gender'); 
				$chorusId=$request->get('chorusId');  
				$Password=$request->get('Password'); 
				$Address=$request->get('Address'); 
				$department=$request->get('department');
				$location=$request->get('location'); 
				$id=$request->get('editId');
				$uploadfile="";
				$ImagePath="";	
				$date=date("dMY_H:i:s");
				$path_parts = pathinfo($_FILES["uploadedFile"]["name"]);
				$path_parts['dirname'] ;
				$path_parts['basename'] ;
				$exten = $path_parts['extension'] ;
				$filename= $path_parts['filename'] ;
				$uploadedFile = $filename.'_'.$date.'.'.$exten;
				$customerName = $em->createQuery("SELECT j.customername FROM TraxAdminBundle:TblUser j  where j.userid='".$loginuserId."' ")->getArrayResult();
				if($id=="")
				{

					if($uploadedFile!=""){
					$uploadfile = $uploadedFile;
					$uploadurl = '/var/www/html/MichelinClassroom/web/logofile/';
					$uploadfilenew='logofile/'.$customerName[0]['customername'].'/'.$uploadedFile;
					$directoryName=$uploadurl.$customerName[0]['customername'];
					$ImagePath=$directoryName.'/'.$uploadedFile;
					$Tempfile= $_FILES["uploadedFile"]["tmp_name"];
					move_uploaded_file($Tempfile,$ImagePath);
					chmod($ImagePath, 0777);
					}

					$insert=new TblUser();
					$insert->setUsername($Username);
					$insert->setPassword($Password);
					$insert->setEmailid($Username);
					$insert->setAddress($Address);
					$insert->setFilename($uploadfilenew);
					$insert->setImagepath($ImagePath);
					$insert->setUsertypeid($usertypeid); 
					$insert->setAdminid($loginId);
					$insert->setCreatedat(new \DateTime());						
					$insert->setStatus("active");
					$em->persist($insert);
					$em->flush();
   					$userId = $insert->getUserid();

					$insert=new TblEmployee();
					$insert->setUserid($userId);
					$insert->setEmployeename($Employeename[0]);
					$insert->setEmployeetype($employeeType);
					$insert->setChorusid($chorusId);
					$insert->setDepartment($department);
					$insert->setLocation($location);
					$insert->setGender($gender);
					$insert->setCustomerid($customerId);
					$insert->setAdminid($loginId);
					$insert->setCreatedat(new \DateTime());				
					$em->persist($insert);
					$em->flush();

				}
				else
				{
				$edituserId=$request->get('edituserId'); 
				$dob = date("Y-m-d", strtotime($DateofBirth));
				$doj = date("Y-m-d", strtotime($DateofJoining));		
				$em->createQuery("update TraxAdminBundle:TblEmployee p set p.companyid='".$groupCompanyId."',p.employeetype='".$employeeType."',p.employeename='".$name."',p.location='".$location."',p.employeeage='".$Age."',p.department='".$department."',p.dateofjoin='".$doj."',p.dateofbirth='".$dob."' WHERE p.empid='".$id."' ")->execute();

				$em->createQuery("update TraxAdminBundle:TblUser p set p.mobileno='".$Mobile."',p.address='".$Address."' WHERE p.userid='".$edituserId."' ")->execute();
									
	
				}
				
			}
		if($type=="TrainingBatch")
			{

 				$batchName=$request->get('batchName'); 
				$Description=$request->get('Description'); 
				 $id=$request->get('editId'); 
				if($id=="")
				{
					$insert=new TblBatch();
					$insert->setBatchname($batchName);
					$insert->setDescription($Description);
					$insert->setAdminid($loginId);
					$insert->setCustomerid($customerId);
					$insert->setCreatedat(new \DateTime());				
					$em->persist($insert);
					$em->flush();

				}	
				else
				{
				$em->createQuery("update TraxAdminBundle:TblBatch p set p.batchname='".$batchName."',p.description='".$Description."',p.customerid='".$customerid."'  WHERE p.batchid='".$id."' ")->execute();
					
				}

			}
			if($type=="TrainingProgram")
			{

				$batchName=$request->get('batchName'); 
				$Programname=$request->get('Programname'); 
				$Description=$request->get('Description'); 
				$id=$request->get('editId');

				if($id=="")
				{
					$insert=new TblTrainingprogram();
					$insert->setBatchid($batchName);
					$insert->setProgramname($Programname);
					$insert->setDescription($Description);
					$insert->setAdminid($customerId);
					$insert->setCreatedat(new \DateTime());				
					$em->persist($insert);
					$em->flush();

				}
				else
				{
				$em->createQuery("update TraxAdminBundle:TblTrainingprogram p set p.programname='".$Programname."',p.description='".$Description."'  WHERE p.prgid='".$id."' ")->execute();
					
				}

			}
     			if($type=="TrainingSchedule")
			{
				$batchName=$request->get('batchName'); 
				$ProgramName=$request->get('ProgramName'); 
				$Trainername=$request->get('Trainername'); 
				$date=$request->get('date'); 
				$Department=$request->get('Department'); 
				$ModuleCategory=$request->get('ModuleCategory'); 
				$employeelist=$request->get('employeelist'); 
				$id=$request->get('editId');
			        
				if($id=="")
				{
					for($i=0;$i<count($employeelist);$i++)
					{ 
						$insert=new TblTrainingschedule();
						$insert->setBatchid($batchName);
						$insert->setProgramid($ProgramName);
						$insert->setModulecateid($ModuleCategory);
						$insert->setTrainername($Trainername);
						$insert->setScheduledate(new \DateTime($date));
						$insert->setDepartid($Department);
						$insert->setCustomerid($customerId);
						$insert->setAdminid($loginId);
						$insert->setEmployeeid($employeelist[$i]);
						$insert->setCreatedat(new \DateTime());
						$em->persist($insert);
						$em->flush();
					}
				}
			}
			if($type=="ModuleCategory")
			{
				$Category=$request->get('Category'); 
				$Description=$request->get('Description'); 
				$val=$request->get('val'); 

				if($val=='1'){
					
					$customerId=$request->get('customerId');
					$loginIdTrainer=$request->get('loginemployeeuserId');
					$loginId=$request->get('loginemployeeuserId');
				}
				else{
				$loginIdTrainer=$request->get('Trainer');
				}				
				$id=$request->get('editId');
		
				if($id=="")
				{
					$insert=new TblModulecategory();
					$insert->setModulecategory($Category);
					$insert->setDescription($Description);
					$insert->setTrainerid($loginIdTrainer);
					$insert->setCustomerid($customerId);
					$insert->setAdminid($loginId);
					$insert->setCreatedat(new \DateTime());				
					$em->persist($insert);
					$em->flush();

				}
				else
				{
				$em->createQuery("update TraxAdminBundle:TblModulecategory p set p.modulecategory='".$Category."',p.description='".$Description."' WHERE p.cateid='".$id."' ")->execute();
					
				}	
			}
			if($type=="ModuleSubCategory")
			{
				$loginIdTrainer=$request->get('Trainer'); 
				$CategoryId=$request->get('CategoryId'); 
				$Description=$request->get('Description'); 
				$SubCategory=$request->get('SubCategory'); 
				$val=$request->get('val'); 

				if($val=='1'){
					$loginIdTrainer=$request->get('loginemployeeuserId');
					$customerId=$request->get('customerId');
					$loginId=$request->get('loginemployeeuserId');  
				}
				
				$id=$request->get('editId');

				if($id=="")
				{
					$insert=new TblModulesubcategory();
					$insert->setCatid($CategoryId);
					$insert->setSubcategory($SubCategory);
					$insert->setDescription($Description);
					$insert->setTrainerid($loginIdTrainer);
					$insert->setCustomerid($customerId);
					$insert->setAdminid($loginId);
					$insert->setCreatedat(new \DateTime());				
					$em->persist($insert);
					$em->flush();

				}
				else
				{
				$em->createQuery("update TraxAdminBundle:TblModulesubcategory p set p.catid='".$CategoryId."',p.subcategory='".$SubCategory."',p.description='".$Description."' WHERE p.subcatid='".$id."' ")->execute();
					
				}	
			}
			
			if($type=="Module")
			{

				$val=$request->get('val'); 
				if($val=='1'){
					
					$customerId=$request->get('customerId');
					$loginId=$request->get('loginemployeeuserId');  
					$Trainer=$request->get('loginemployeeuserId');
				}
				else{
					$Trainer=$request->get('Trainer');
				}
					$fileType="";
					$Category=$request->get('CategoryId');
					$ModuleName=$request->get('ModuleName');
					$Description=$request->get('Description');
					$id=$request->get('editId');
					$SubCategory=$request->get('SubCategory'); 
					$uploadedFilenew = $request->files->get('uploadedFile');
					$uploadfile="";
					$ImagePath="";
					$date = date("Y-m-d H:i:s");
					$path_parts = pathinfo($_FILES["uploadedFile"]["name"]);
					$path_parts['dirname'] ;
					$path_parts['basename'] ;
					$exten = $path_parts['extension'] ;
					$filename= $path_parts['filename'] ;
					$uploadedFile = $filename.'_'.$date.'.'.$exten;
					$categoreyName=$em->createQuery("SELECT p FROM TraxAdminBundle:TblModulesubcategory p where p.subcatid='".$SubCategory."' ")->getArrayResult();
					$catName=$categoreyName[0]['subcategory'];
					if($id=="")
					{
						if($exten== 'jpg' || $exten== 'png' || $exten== 'jpeg' || $exten== 'gif' || $exten== 'zip' || $exten== 'docx' || $exten== 'doc' || $exten== 'odt'|| $exten== 'ods' || $exten== 'odp' || $exten== 'pdf' || $exten== 'mp4'|| $exten== 'webm'|| $exten== 'ogg'|| $exten== 'mp3' )	
						{
								if($uploadedFile!=""){
							
									if($exten != 'zip'){
									$uploadfile = $uploadedFile;
									$uploadurl = '/var/www/html/MichelinClassroom/web/uploadfiles';
									$ImagePath=$uploadurl.'/'.$catName;
									mkdir($ImagePath,0777);
									chmod($ImagePath, 0777);
									$type=$ImagePath."/".$uploadfile;
									$Tempfile= $_FILES["uploadedFile"]["tmp_name"];
									move_uploaded_file($Tempfile,$type);
									chmod($type, 0777);
									$Filepath=$type;
									
									}else{

									$fileType="Story";
									$uploadfile = $filename.'_'.$date;
									$uploadurl = '/var/www/html/MichelinClassroom/web/uploadfiles/';

									$ImagePath=$uploadurl.'/'.$catName;
									mkdir($ImagePath,0777);
									chmod($ImagePath, 0777);

									$directoryName=$ImagePath.$ModuleName.'_'.$date;
									mkdir($directoryName,0777);
									chmod($directoryName, 0777);
									$Tempfile= $_FILES["uploadedFile"]["tmp_name"];
									$file=$_FILES["uploadedFile"];
									$ImagePath=$directoryName;
									$fileextr=$ImagePath."/".$_FILES["uploadedFile"]["name"];
									$Filepath=$ImagePath;
									move_uploaded_file($Tempfile,$fileextr);
									$zip = new \ZipArchive();
									if ($zip->open($fileextr) === TRUE) {
									$zip->extractTo($directoryName);
									$zip->close();
									} 
									unlink($fileextr);
							

									}
									
								}

						}

					

						$insert=new TblModulefiles();
						$insert->setModulecategory($Category);
						$insert->setSubcategory($SubCategory);
						$insert->setModulename($ModuleName);
						$insert->setDescription($Description);
						$insert->setTrainerid($Trainer);
						$insert->setFiletype($fileType);
						$insert->setFilename($uploadfile);
						$insert->setFilepath($Filepath);
						$insert->setCustomerid($customerId);
						$insert->setAdminid($loginId);
						$insert->setCreatedat(new \DateTime());	
						$em->persist($insert);
						$em->flush();
					
				}
				
				else
				{

						if($exten == 'odt' || $exten == 'odp' || $exten == 'ods' || $exten == 'pdf')	
						{
							if($uploadedFile!=""){

								$uploadfile = $uploadedFile;
								$uploadurl = '/var/www/html/MichelinClassroom/web/uploadfiles';
								$ImagePath=$uploadurl.'/'.$uploadfile;
								$Tempfile= $_FILES["uploadedFile"]["tmp_name"];
								move_uploaded_file($Tempfile,$ImagePath);
								chmod($ImagePath, 0777);
					
								}

					$em->createQuery("update TraxAdminBundle:TblModulefiles p set p.modulecategory='".$Category."',p.modulename='".$ModuleName."',p.description='".$Description."',p.filename='".$uploadfile."',p.filepath='".$ImagePath."' WHERE p.moduleid='".$id."' ")->execute();
						}
					
				}	
	
			}

			if($type=="MapModule")
			{				
//print_r($_REQUEST);
				$Trainer=$request->get('Trainer'); 
				$customerId=$request->get('customerId'); 
				if($customerId!=''){
					$customerId=$customerId;
					$loginId=$request->get('loginuserId'); 
				}
				else{
					$customerId = $session->get('loginId');
				}			
				$Category=$request->get('CategoryId'); 
				$SubCategory=implode(",",$request->get('subCategory_to')); 
				$elearningModule=implode(",",$request->get('elearningModule')); 
				$reservation=$request->get('reservation'); 
				$select_All=$request->get('select_All');
				$Description=$request->get('Description');

				if($select_All=="on"){
				 $selectallEmployee=$request->get('selectallEmployee');				
				$Trainee=$em->createQuery("SELECT j.userid FROM TraxAdminBundle:TblEmployee j where j.department in (".$selectallEmployee.") and j.employeetype ='Trainee' and j.customerid='".$customerId."' ")->getArrayResult();
//print_r($Trainee);

				for($k=0; $k<count($Trainee); $k++){
						$employee.=$Trainee[$k]['userid'].",";
					}
					
				$employeelistarr =rtrim($employee,',');
					$employeelist=explode(',',$employeelistarr);		
				}
				else{
				$employeelist=$request->get('employeelist'); 
				}
				$id=$request->get('editId');
				
				if($id=="")
				{
						$insert=new TblMapmodule();
						$insert->setTrainerid($Trainer);
						$insert->setCategoryid($Category);
						$insert->setSubcategory($SubCategory);
						$insert->setDescription($Description);
						$insert->setModuleid($elearningModule);
						$insert->setScheduledate($reservation);
						$insert->setCustomerid($customerId);
						$insert->setAdminid($loginId);
						$insert->setCreatedat(new \DateTime());				
						$em->persist($insert);
						$em->flush();
					   	
						$mapid = $insert->getMapid();
						for($i=0;$i<count($employeelist);$i++){
							$insert=new TblMapbatchtoemployee();
							$insert->setMapmoduleid($mapid);
							$insert->setEmployeeid($employeelist[$i]);
							$insert->setCustomerid($customerId);
							$insert->setAdminid($loginId);
							$insert->setCreatedat(new \DateTime());				
							$em->persist($insert);
							$em->flush();	
						}
					

					
				}
				else
				{
							
				}	
			}

			if($type=="MapModuleNew")
			{
				$customerId = $session->get('customerId');
				$department=$request->get('department');
				$cate=$request->get('category');
				$loginId = $request->get('loginId');
				$employee=$request->get('employee');
				$depforEmp=$request->get('depforEmp');
				//echo "category".$cate."department".$department;


				$department=explode(",",$department);
				$cate=explode(",",$cate);
				$employee=explode(",",$employee);
				for($i=0; $i<count($department); $i++)
				{
					if($department!="")
					{
					$mapping = $em->createQuery("SELECT j.empid FROM TraxAdminBundle:TblEmployee j where j.department='".$department[$i]."' and j.employeetype ='Employee' and j.customerid='".$customerId."' ")->getArrayResult();
					for($j=0; $j<count($mapping); $j++)
					{
						$studid=$mapping[$j]['empid'];
						for($k=0; $k<count($cate); $k++)
						{
							$insert=new TblMapmodule();
							$insert->setCategoryid($cate[$k]);
							$insert->setDepartid($department[$i]);
							$insert->setEmployeeid($studid);
							$insert->setDescription($Description);
							$insert->setCustomerid($customerId);
							$insert->setAdminid($loginId);
							$insert->setCreatedat(new \DateTime());				
							$em->persist($insert);
							$em->flush();
						}
					}
					}
				}

				for($i=0; $i<count($employee); $i++)
				{
					$studid=$employee[$i];
					if($studid!="")
					{
						for($j=0;$j<count($cate);$j++)
						{
								$insert=new TblMapmodule();
								$insert->setCategoryid($cate[$j]);
								$insert->setDepartid($depforEmp);
								$insert->setEmployeeid($studid);
								$insert->setDescription($Description);
								$insert->setCustomerid($customerId);
								$insert->setAdminid($loginId);
								$insert->setCreatedat(new \DateTime());				
								$em->persist($insert);
								$em->flush();
							echo $msg="Successfully Inserted";
						}
					}
					else
					{
							echo $msg=""; 
					}
				}

			}
		if ($type=="uploadMaster") 
		{
		
			$csvMimes = array('application/vnd.ms-excel','text/plain','text/csv','text/tsv');
			if(!empty($_FILES['file']['name']) && in_array($_FILES['file']['type'],$csvMimes))
			{
				if(is_uploaded_file($_FILES['file']['tmp_name']))
				{
				$csvFile = fopen($_FILES['file']['tmp_name'], 'r');
	
				$arrCSV=array();
				$i=0;
				$em->createQuery("Delete FROM TraxAdminBundle:TblBasicdetails j")->execute();
					while(($data = fgetcsv($csvFile, 1000, ",")) !== FALSE)
					{

					$arrCSV[$i]=$data;
					$num =count($data);
					$i++;
					}
						
					
					for($j=0;$j<count($arrCSV);$j++)
					{
			
						$insert=new TblBasicdetails();
						$insert->setEmployeename($arrCSV[$j][0]);
						$insert->setEmaiid($arrCSV[$j][1]);
						$insert->setChorusid($arrCSV[$j][2]);
						$insert->setGuid($arrCSV[$j][3]);
						$insert->setCustomerid($customerId);
						$insert->setAdminid($loginuserId);
						$insert->setCreatedat(new \DateTime());				
						$em->persist($insert);
						$em->flush();

					}                   
					echo "Sucess";
					fclose($csvFile);

			  
				}		
			}          

		}
			
			
			
        return $this->render('TraxAdminBundle:Admin:InsertAdminMaster.html.php',array('mastertype'=>$mastertype));
	}
 	public function BasicMasterAction(Request $request)
	{
		$em = $this->getDoctrine()->getEntityManager();
        	$session = $request->getSession();
		$loginExeType = $session->get('loginExeType');
		$loginuserId = $session->get('loginuserId');
		$loginId = $session->get('loginId');
		if($loginExeType==1){			
		 		$customerList = $em->createQuery("SELECT j.userid,j.customername FROM TraxAdminBundle:TblUser j  where j.usertypeid=2 and j.status='active' ")->getArrayResult();
				}

				

	
	return $this->render('TraxAdminBundle:Admin:BasicMaster.html.php',array('loginExeType'=>$loginExeType,'customerList'=>$customerList));
	}
public function MapModuleAction(Request $request)
	{
		$em = $this->getDoctrine()->getEntityManager();
        	$session = $request->getSession();
		$loginExeType = $session->get('loginExeType');
		$loginuserId = $session->get('loginuserId');
		$loginId = $session->get('loginId');
		if($loginExeType==1){			
		 		$customerList = $em->createQuery("SELECT j.userid,j.customername FROM TraxAdminBundle:TblUser j  where j.usertypeid=2 and j.status='active' ")->getArrayResult();
				}
		
		
		$TrainerList=$em->createQuery("SELECT j.userid,j.employeename  FROM TraxAdminBundle:TblEmployee j  where j.employeetype ='Trainer' and j.customerid='".$loginuserId."'")->getArrayResult();
	return $this->render('TraxAdminBundle:Admin:MapModule.html.php',array('loginExeType'=>$loginExeType,'customerList'=>$customerList,'ModuleCategory'=>$ModuleCategory,'departList'=>$departList,'TrainerList'=>$TrainerList));
	}
public function addEmployeeMasterAction(Request $request)
	{
		$em = $this->getDoctrine()->getEntityManager();
        	$session = $request->getSession();
		$loginExeType = $session->get('loginExeType');
		$loginuserId = $session->get('loginuserId');
		$loginId = $session->get('loginId');
		if($loginExeType==1){			
		 		$customerList = $em->createQuery("SELECT j.userid,j.customername FROM TraxAdminBundle:TblUser j  where j.usertypeid=2 and j.status='active' ")->getArrayResult();
				}
				$locationList = $em->createQuery("SELECT k FROM TraxAdminBundle:TblLocation k where k.customerid='".$loginuserId."' order by k.zoneid desc")->getArrayResult();
				$DepartmentList = $em->createQuery("SELECT j.dprtid,j.department  FROM TraxAdminBundle:TblDepartment j  where j.customerid ='".$loginuserId."'")->getArrayResult();
				$editId=$request->get('editId');
				if($editId!=""){
				$editEmployeeList = $em->createQuery("SELECT j.employeename,k.username,k.password,k.address,j.employeetype,k.mobileno,l.dprtid,m.zoneid  FROM TraxAdminBundle:TblEmployee j INNER JOIN TraxAdminBundle:TblUser k with k.userid=j.userid  INNER JOIN TraxAdminBundle:TblDepartment l with l.customerid=j.customerid INNER JOIN TraxAdminBundle:TblLocation m with m.customerid=j.customerid where j.empid ='".$editId."'")->getArrayResult();

				}

	return $this->render('TraxAdminBundle:Admin:addEmployeeMaster.html.php',array('loginExeType'=>$loginExeType,'customerList'=>$customerList,'locationList'=>$locationList,'DepartmentList'=>$DepartmentList,'loginuserId'=>$loginuserId));
	}

}
